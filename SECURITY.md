# Политика безопасности (Security) — REN Messenger

Этот документ описывает модель угроз, криптографию, операционные меры, безопасную конфигурацию и процессы реагирования на инциденты. Система использует полное сквозное шифрование (E2EE): приватные ключи создаются и хранятся на клиенте, сервер обрабатывает только зашифрованные данные и метаданные.

## 1) Модель угроз

### Активы
- Содержимое сообщений и файлов (конфиденциальность/целостность)
- Криптографические ключи пользователей (особенно приватные)
- Данные аккаунтов и метаданные (логины, аватары, время активности)

### Потенциальные противники
- Злоумышленник, перехватывающий трафик сети
- Компрометация серверной инфраструктуры
- Вредонос на клиентском устройстве
- Злоупотребление API (брютфорс, массовые регистрации, scraping)

### Не цели
- Сервер не должен иметь возможности расшифровывать контент E2EE
- Система не хранит открытые приватные ключи пользователей

## 2) Криптография (E2EE)

### Ключи
- Генерация на клиенте: ECDH P‑256
- Двойное шифрование приватного ключа:
  - `E(PrK_U, MK_U)` — мастер‑ключ из пароля и соли (PBKDF2‑SHA256, >=100k итераций)
  - `E(PrK_U, AccessKey_U)` — отдельный ключ доступа (генерируется на сервере и показывается пользователю)

### Сообщения и файлы
- Алгоритм: AES‑GCM‑256
- IV/nonce: 12 байт, уникален на шифротекст
- Аутентификация: встроенная в GCM (integrity + authenticity)

### Процессы
- Регистрация: клиент генерирует ключи → шифрует приватный ключ → сервер выдаёт access key → клиент дополнительно шифрует приватный ключ access key
- Вход: сервер отдаёт JWT + криптоданные → клиент деривирует мастер‑ключ и расшифровывает приватный ключ
- Восстановление: по access key возвращается зашифрованный приватный ключ → пользователь меняет пароль → перешифровка

## 3) Аутентификация и сессии
- JWT в заголовке `Authorization: Bearer <token>`
- Применяйте разумные сроки жизни токена (по умолчанию 30 минут) и автоматическое обновление по UX‑политике
- Ревокация: при критических событиях (взлом/утечка) — принудительная инвалидция активных токенов

## 4) Транспортная безопасность
- Production: только HTTPS (TLS ≥ 1.2, рекомендуется 1.3)
- HSTS, `X-Content-Type-Options: nosniff`, `X-Frame-Options: DENY`
- CSP для фронтенда (минимум: ограничить источники скриптов/медиаконтента)
- WebSocket — только через WSS в проде

## 5) Хранение и доступ к данным
- Сервер хранит только зашифрованные полезные данные и метаданные
- DB учётка с минимально необходимыми правами (principle of least privilege)
- Бэкапы: шифрование, ограниченный доступ, стратегия хранения и восстановления
- По возможности — шифрование «в покое» на уровне диска/СУБД

## 6) Логирование и приватность
- Не логировать секреты, токены, приватные ключи, access key, содержимое сообщений/файлов
- Логировать только метаданные операций (вход, ошибки, подозрительная активность)
- Жизненный цикл логов: срок хранения, доступ по принципу наименьших привилегий
- В dev можно повышать уровень логирования, в prod — `ERROR`/`WARN` по необходимости

## 7) Rate limiting и защита API
- Лимитировать критические эндпоинты:
  - `/recover_account_by_access_key`: например, 3/час
  - `/login`: например, 10/мин
  - `/register_step1`: лимит новых аккаунтов
- Простейший пример (FastAPI + slowapi):
```python
from slowapi import Limiter
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
```

## 8) CORS
- Настраивается через переменную `CORS_ORIGINS` (список доменов)
- На dev может использоваться `*`, в prod — только доверенные домены

## 9) Безопасность загрузки файлов
- Проверка типов/размеров (white‑list, лимит на размер)
- Жёсткая нормализация путей, запрет обхода каталогов (path traversal)
- Для видео — хранение чанков отдельно, метаданные без base64 контента
- Возможность антивирусного сканирования/сканера контента на стороне сервера (опционально)

## 10) Фронтенд безопасность
- Все чувствительные операции — только через HTTPS/WSS
- Не хранить секреты в LocalStorage, кроме краткоживущих токенов (пересмотреть по требованиям)
- CryptoKey объекты хранить недоступными для извлечения, где это применимо
- IndexedDB: хранить только то, что нужно; очищать при выходе

## 11) Управление секретами и конфигурацией
- Секреты (`SECRET_KEY`, пароли БД, доступы) — только через переменные окружения/.env вне VCS
- Ротация ключей и паролей — по регламенту (plan‑of‑action)
- Раздельные конфиги для dev/stage/prod

## 12) Зависимости и обновления
- Регулярные обновления зависимостей (SCA)
- Использовать проверенные источники пакетов
- Пиновать версии, следить за advisories (GitHub Security Advisories, npm audit, pip audit)

## 13) CI/CD и инфраструктура
- Secrets в CI хранить в защищённых Secret Store
- Минимизировать выдачу прав Runner’ам
- Подписанные сборки/артефакты (где возможно)

## 14) Тестирование безопасности
- Регулярный пентест ключевых путей (регистрация, вход, отправка сообщений)
- Статический анализ (SAST) и/или линтеры безопасности
- Тесты криптографии и интеграционные тесты E2EE потока

## 15) Мониторинг и реагирование на инциденты

### Индикаторы компрометации
- Всплески неуспешных логинов
- Необычная активность восстановления
- Нетипичные запросы к файловым эндпоинтам

### План реагирования (runbook)
1. Классифицировать инцидент (критичность, затронутые активы)
2. Сдерживание: блокировка IP/токенов, усиление лимитов
3. Аналитика: анализ логов, трасс, бэкапов
4. Устранение: фиксы, патчи, ротация секретов
5. Коммуникации: уведомление команды/пользователей (если требуется)
6. Пост‑морем: улучшения процессов и контролей

## 16) Чек‑лист перед продакшеном
- [ ] HTTPS/WSS настроены, HSTS включён
- [ ] CORS ограничён доверенными доменами
- [ ] Rate limiting активирован
- [ ] Логи не содержат чувствительных данных
- [ ] DB доступ по принципу наименьших прав
- [ ] ENV секреты не в репозитории
- [ ] Бэкапы есть и протестированы

## 17) Мобильное приложение (план)
- Паритет криптомодели с веб‑клиентом (ECDH P‑256, AES‑GCM‑256, PBKDF2)
- Безопасное хранение ключей (Secure Enclave/KeyStore)
- Совместимость форматов сообщений/метаданных
- Обновлённая модель угроз (офлайн‑устройства, джейлбрейк/рут)
